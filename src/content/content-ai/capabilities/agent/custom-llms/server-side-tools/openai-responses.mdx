---
title: 服务器端工具（OpenAI Responses API）
meta:
  title: 服务器端工具（OpenAI Responses API）| Tiptap 内容 AI
  description: 学习如何使用 OpenAI Responses API 在服务器端调用工具。
  category: 内容 AI
---

本指南讲解如何使用 OpenAI Responses API 在服务器端调用工具。这里展示了一个返回指定地点天气的工具示例。

首先，按照 [OpenAI Responses API 工具格式](https://platform.openai.com/docs/guides/function-calling?api-mode=responses#defining-functions) 定义工具：

```ts
const weatherTool = {
  type: 'function',
  function: {
    name: 'get_weather',
    description: '返回指定位置的天气',
    parameters: {
      type: 'object',
      properties: {
        location: {
          type: 'string',
          description: '获取天气的地点',
        },
      },
      required: ['location'],
    },
  },
}
```

然后，在调用 OpenAI API 时，将该工具包含在 `tools` 数组中：

```ts
import { AiAgentToolkit } from '@tiptap-pro/extension-ai-agent-server'
import { openaiResponsesAdapter } from '@tiptap-pro/extension-ai-agent'
import OpenAI from 'openai'

const toolkit = new AiAgentToolkit()

// 初始化 OpenAI 客户端
const openai = new OpenAI()

// 调用 OpenAI Responses API
const response = await openai.responses.create({
  model: 'gpt-4.1',
  input: [
    {
      role: 'developer',
      content: `
<Your system prompt>
${toolkit.getSystemPrompt()}
`,
    },
    ...llmMessages,
  ],
  // 在 tools 数组中包含天气工具，连同 AiAgentToolkit 提供的其他工具
  tools: [...toolkit.getTools(openaiResponsesAdapter), weatherTool],
})
```

接着，检查响应是否包含天气工具调用。如有，则调用该工具，并将结果添加到 `llmMessages` 数组中。

```ts
for (const toolCall of response.output) {
  if (toolCall.type !== 'function_call') {
    continue
  }

  const name = toolCall.name

  if (name !== 'get_weather') {
    continue
  }

  const args = JSON.parse(toolCall.arguments)

  const result = getWeather(args)
  llmMessages.push({
    type: 'function_call_output',
    call_id: toolCall.call_id,
    output: result.toString(),
  })
}
```

最后，当没有更多服务器端工具调用时，使用 `openaiResponsesAdapter` 将响应转换为 AI Agent 扩展所期望的格式。

```ts
const result = openaiResponsesAdapter.parseResponse(response)
```

`result` 应为 API 端点的响应，也是 `resolver` 函数的返回值。

你还可以向 `result` 添加描述被调用工具的聊天消息，这样可在聊天对话中显示工具调用的结果。

```ts
// 将工具调用消息添加到新聊天消息列表的开头
result.chatMessages.unshift({
  type: 'ai',
  text: '柏林的天气是晴朗的。',
  metadata: {
    // 添加此元数据以标记消息为服务器端工具调用
    // 并在 UI 中以不同方式显示
    isServerSideToolCall: true,
  },
})
```