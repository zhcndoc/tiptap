---
title: AI 代理状态管理
meta:
  title: AI 代理状态管理 | Tiptap 内容 AI
  description: 了解如何管理 Tiptap 中 AI 代理的状态。
  category: 内容 AI
---

AI 代理提供程序维护一个内部状态，用于跟踪对话、状态和其他重要信息。您可以访问此状态以更新应用程序的 UI。

## 访问状态

您可以直接访问状态及其属性：

```tsx
// 访问当前状态
const currentState = provider.state

// 访问状态的一个属性
currentState.status
```

或者您可以订阅状态变化：

```tsx
provider.on('stateChange', (newState) => setState(newState))
```

## 状态属性

提供程序的状态包括以下关键属性：

```tsx
interface AiAgentProviderState {
  // 当前状态："idle"，"loading"，"loadingError"或"reviewingToolCall"
  status: AiAgentStatus

  // 加载过程中发生的错误（如果有）
  loadingError: unknown

  // 对话中的所有聊天消息数组
  chatMessages: ChatMessage[]

  // 等待用户审核的消息
  chatMessagesPendingReview: {
    accept: ChatMessage[]
    reject: ChatMessage[]
  }

  // 当前自动接受设置
  autoAccept: 'always' | 'never' | 'onlyRead'
}
```

## 状态转换

AI 代理作为一个状态机，具有以下可能的状态：

1. `idle`：代理当前没有在处理任何事情
2. `loading`：代理正在处理对服务器的请求
3. `loadingError`：处理过程中发生了错误
4. `reviewingToolCall`：代理正在等待用户接受/拒绝工具调用

您可以使用这些状态值相应地更新您的 UI，例如显示加载指示器或错误消息。

## 聊天消息类型

AI 代理对话中的聊天消息存储在 `provider.state.chatMessages` 属性中。它可以包含不同类型的消息：

```jsonl
// 用户消息
{ type: "user", text: "总结一下这份文档" }

// AI 响应消息
{ type: "ai", text: "这是文档的摘要..." }

// 工具调用消息（当 AI 调用工具时）
{
  type: "toolCall",
  name: "read_first_chunk",
  arguments: {},
  llmMessage: {...}
}

// 工具调用结果消息
{
  type: "toolCallResult",
  name: "read_first_chunk",
  llmMessage: {...}
}

// 检查点消息（保存编辑器状态）
{
  type: "checkpoint",
  checkpoint: {
    chatMessages: [...],
    editorContent: "<p>文档内容...</p>"
  }
}
```

所有消息都有一个 `metadata` 属性，您可以在其中存储其他信息。

## 管理消息

对话中的初始消息在 `initialMessages` 选项中定义。要修改消息列表，提供程序包含以下方法：

```tsx
// 插入用户消息
provider.addUserMessage('写一个短故事')

// 在对话中插入不同类型的消息
provider.addMessages([
  {
    type: 'ai',
    text: '我能帮您什么吗？',
  },
])

// 完全替换对话
provider.setMessages([])
```

## 重置 AI 代理的状态

您可以通过调用 `reset` 方法重置 AI 代理的状态。这将清除对话并将内部状态重置为初始值。

```tsx
provider.reset()
```