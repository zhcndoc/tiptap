---
title: AI代理生命周期
meta:
  title: AI代理生命周期 | Tiptap内容AI
  description: 了解在Tiptap中运行的AI代理的生命周期。
  category: 内容AI
---

AI代理的运行是用户、AI代理和文档之间交互的完整循环。理解运行生命周期可以帮助您构建更好的集成和用户体验。

## 运行生命周期

1. **初始化**：当您在添加用户消息后调用 `provider.run()` 时，运行开始
2. **处理**：AI代理处理请求，调用LLM。LLM模型以消息和/或工具调用做出响应。
3. **工具执行**：AI代理执行工具以读取或修改文档
4. **循环**：AI代理继续调用LLM和执行工具，直到满足终止条件。
5. **完成**：当AI代理完成任务、需要用户审核或遇到错误时，运行结束

## 运行状态

在运行期间，AI代理会经历不同的状态：

1. **空闲** → **加载**：当调用 `run()` 时
2. **加载** → **审核工具调用**：当工具调用需要用户审核时
3. **加载** → **加载错误**：当发生错误时
4. **加载** → **空闲**：当满足以下条件之一时：
   - 执行了最终工具调用。最终工具调用会停止在其他工具调用后自动循环执行工具调用。最终工具调用是工具调用处理对象中的 `isFinal` 属性设置为 `true` 的调用。
   - LLM以消息响应且未调用任何工具。
   - AI代理通过 `provider.stop()` 停止。
   - 在当前运行结束之前，通过 `provider.run()` 启动另一个运行。

## 并发运行AI代理

要同时运行多个AI代理，可以实例化多个编辑器和AI代理提供者。在其当前版本中，AI代理扩展不支持在同一编辑器中运行多个AI代理。如果在调用 `provider.run()` 时已有运行在进行中，则当前运行将在新运行开始前被中断。

## 控制运行

您可以使用以下方法控制AI代理的运行：

```tsx
// 开始一个运行
provider.run()

// 停止进行中的运行
provider.stop()
```

## 自动运行 vs. 手动控制

默认情况下，AI代理在添加用户消息后不会自动运行。您需要显式调用 `run()`：

```tsx
// 添加消息并运行AI代理
provider.addUserMessage('使用适当的标题格式化此文档')
provider.run()
```

## 处理运行完成

```tsx
// 订阅 runFinished 事件
provider.on('runFinished', (context) => {
  console.log('AI代理运行完成')
  showCompletionNotification('AI代理已完成任务')
})
```