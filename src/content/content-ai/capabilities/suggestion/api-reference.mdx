---
title: AI 建议扩展 API 参考
meta:
  title: API 参考 | Tiptap AI 建议
  description: Tiptap AI 建议扩展的 API 参考。
  category: 内容 AI
---

## 扩展选项

```ts
/**
 * AI 建议扩展的配置选项。
 */
export interface AiSuggestionOptions {
  /** 审校过程中应用的规则
   * @default []
   */
  rules: AiSuggestionRule[]
  /** 在进行任何审校之前显示的初始建议
   * @default []
   */
  initialSuggestions: Suggestion[]
  /** 在进行任何审校之前应用的推荐拒绝
   * @default []
   */
  initialRejections: AiSuggestionRejection[]
  /** 自定义在编辑器中建议装饰的函数
   * @default `getDefaultDecorations()`
   * @param args - 定制建议装饰的参数。
   * @return 一个 `Decoration` 对象数组。
   */
  getCustomSuggestionDecoration: (args: GetCustomSuggestionDecorationOptions) => Decoration[]
  /** 内容变更后等待重新加载建议的时间（毫秒）
   * @default 800
   */
  debounceTimeout: number
  /** 初始化时是否加载建议
   * @default true
   */
  loadOnStart: boolean
  /** 内容变化时是否重新加载建议
   * @default true
   */
  reloadOnUpdate: boolean
  /** 加载建议出错时的回调
   * @param error - 发生错误的建议加载过程中的错误。
   * @default console.error
   */
  onLoadSuggestionsError: (error: unknown) => void
  /**
   * 用于校对内容和生成建议的AI模型。
   * @default "gpt-4o-mini"
   */
  modelName: AiSuggestionModelName
  /**
   * 从外部加载建议的函数，基于
   * 当前编辑器内容和规则。让你可以使用自己的AI模型分析
   * 内容并返回建议。
   *
   * @param options - 解析建议的参数。
   * @return 一个应应用的建议列表。
   */
  resolver: (options: AiSuggestionCustomResolverOptions) => Promise<Suggestion[]>
  /**
   * Tiptap AI应用ID。
   */
  appId: string
  /**
   * Tiptap AI令牌。
   */
  token: string
  /**
   * Tiptap AI API的基础URL。
   */
  baseUrl: string
  /**
   * 提供额外信息给AI模型以生成建议的可选上下文。
   */
  context: string | null
  /**
   * 是否对编辑器内容进行块划分并缓存每个块的建议。这允许扩展在内容重新加载时重复使用缓存的建议。这对于大型
   * 文档有助于提升性能并降低成本。
   *
   * @default true
   */
  enableCache: boolean
  /**
   * 用于拆分文档的块大小，单位为
   * 顶层子节点数量。
   *
   * @default 2
   */
  chunkSize: number
  /**
   * 拆分编辑器内容的HTML为块的函数。默认情况下，它会依据配置的
   * 块大小，将HTML拆分成更小的片段，并返回HTML块数组。你也可以通过提供自定义函数来覆盖此行为。
   *
   * @param options - 拆分HTML的参数。
   * @returns 块数组
   * @default `defaultChunkHtmlFunction`
   */
  chunkHtmlFunction: (options: ChunkHtmlOptions) => HtmlChunk[]
}
```

## 扩展命令

````ts
declare module '@tiptap/core' {
  interface Commands<ReturnType> {
    aiSuggestion: {
      /**
       * 立即加载AI建议。
       */
      loadAiSuggestions: () => ReturnType
      /**
       * 在扩展选项定义的去抖时间后加载AI建议。
       */
      loadAiSuggestionsDebounced: () => ReturnType
      /**
       * 设置要显示的AI建议。
       *
       * @param suggestions 要显示的建议。
       */
      setAiSuggestions: (suggestions: Suggestion[]) => ReturnType
      /**
       * 选择某个建议。被选中的建议在编辑器中会有不同的样式。
       * */
      selectAiSuggestion: (suggestionId: string) => ReturnType
      /**
       * 将建议应用到编辑器，修改其内容。
       *
       * @param options 建议的ID和被选中的替换方案。如果未提供替换方案，则使用第一个方案。还可以自定义被替换内容的格式。
       */
      applyAiSuggestion: (options: ApplyAiSuggestionOptions) => ReturnType
      /**
       * 将建议标记为被拒绝，移除出建议列表。
       *
       * @param suggestionId 被拒绝建议的ID。
       */
      rejectAiSuggestion: (suggestionId: string) => ReturnType

      /**
       * 设置被拒绝的建议列表。此命令有助于撤销拒绝或清空所有拒绝。
       *
       * @param rejections 被设置的拒绝项。
       */
      setAiSuggestionRejections: (rejections: AiSuggestionRejection[]) => ReturnType

      /**
       * 应用所有未被拒绝的AI建议。每个建议将应用第一个替换选项。
       */
      applyAllAiSuggestions: (options?: ApplyAllAiSuggestionOptions) => ReturnType
      /**
       * 设置AI建议规则。让你可以在不重新加载编辑器的情况下更新规则。
       *
       * 此命令不会重新加载建议。若要使用新规则重新加载建议，请调用：
       *
       * ```js
       * editor.chain().setAiSuggestionRules(newRules).loadAiSuggestions().run()
       * ```
       */
      setAiSuggestionRules: (rules?: AiSuggestionRule[]) => ReturnType

      /**
       * 设置AI建议的上下文。此上下文用于为AI模型提供额外信息，以生成建议。
       *
       * 此命令不会重新加载建议。若要用新上下文重新加载建议，请调用：
       *
       * ```js
       * editor.chain().setAiSuggestionContext(newContext).loadAiSuggestions().run()
       * ```
       *
       * @param context 提供给AI模型的可选额外信息。
       */
      setAiSuggestionContext: (context: string | null) => ReturnType
    }
  }
}

export interface ApplyAiSuggestionOptions {
  /**
   * 要应用的建议ID。如果未找到，则此方法不执行任何操作。
   */
  suggestionId: string
  /**
   * 要应用的替换方案ID。如果为`undefined`，则默认采用第一个替换方案。
   */
  replacementOptionId?: string
  /**
   * 控制建议的应用方式
   * 如果为`rich-text`，建议将以HTML格式显示。
   * 如果为`plain-text`，建议将显示为纯文本。
   * @default "plain-text"
   */
  format?: 'rich-text' | 'plain-text'
}

export interface ApplyAllAiSuggestionOptions {
  /**
   * 控制建议的应用方式
   * 如果为`rich-text`，建议将以HTML格式显示。
   * 如果为`plain-text`，建议将显示为纯文本。
   * @default "plain-text"
   */
  format?: 'rich-text' | 'plain-text'
}
````

## 扩展存储

```ts
/**
 * AI 建议扩展的内部存储。
 */
export interface AiSuggestionStorage {
  /** 扩展使用的ProseMirror插件的键 */
  pluginKey: PluginKey<AiSuggestionProsemirrorPluginState>
  /** 审校过程中应用的规则 */
  rules: AiSuggestionRule[]
  /** 获取当前建议的函数 */
  getSuggestions: () => Suggestion[]
  /** 获取被拒绝建议的函数 */
  getRejections: () => AiSuggestionRejection[]
  /** 获取当前选中的建议的函数 */
  getSelectedSuggestion: () => Suggestion | null
  /** 当前是否正在加载建议 */
  isLoading: boolean
  /** 是否至少加载过一次建议 */
  firstLoad: boolean
  /** 上一次加载尝试中发生的错误（如果有） */
  error: unknown | null
  /** 用于加载建议的去抖函数 */
  debouncedFunction: DebouncedFunction<() => void>
  /** 用于中止加载建议的控制器 */
  abortController: AbortController
  /**
   * 提供给AI模型以生成建议的可选上下文。
   */
  context: string | null
  /**
   * 用于存储每个块的建议的缓存。
   */
  cache: AiSuggestionCache
}

/**
 * 创建编辑器中建议装饰的参数。
 */
export interface GetCustomSuggestionDecorationOptions {
  /** 被装饰的建议 */
  suggestion: Suggestion
  /** 当前该建议是否被选中 */
  isSelected: boolean
  /** 获取扩展提供的默认装饰样式的函数 */
  getDefaultDecorations: () => Decoration[]
}
```

## 扩展类型

### 规则

```ts
/**
 * 审校中应用的规则。
 */
export interface AiSuggestionRule {
  /**
   * 规则的唯一标识符。
   */
  id: string
  /**
   * 规则的标题。不用于审校，而用于显示。
   */
  title: string
  /**
   * 规则的提示信息。会传送给AI模型进行校对。
   */
  prompt: string
  /**
   * 规则颜色。用于划线需要替换的内容。
   */
  color: string
  /**
   * 规则的背景色。当建议被选中时用于高亮内容。
   */
  backgroundColor: string
  /**
   * 规则的额外元数据，可用于存储一些补充信息（如来源或类别）。这不会被扩展内部使用，但可以帮助开发者自定义规则在UI中的显示方式。
   */
  metadata?: any
}
```

### 审校建议

```ts
import { Range } from '@tiptap/core'
import { Slice } from '@tiptap/pm/model'

import { AiSuggestionRule } from './ai-suggestion-rule'

/**
 * 建议的替换方案，包含待添加文本和被替换的slice。
 */
export interface AiSuggestionReplacementOption {
  id: string
  /**
   * 当格式为`plain-text`时，待添加的文本内容。
   */
  addText: string
  /**
   * 当格式为`rich-text`时，待添加的内容Slice。
   */
  addSlice: Slice
}

/**
 * 来自AI建议扩展的建议。它包含待替换范围、删除内容、多个替换方案及需应用的规则。
 *
 * 一个建议可以有多个替换方案。用户可以选择一项应用。
 */
export interface Suggestion {
  /**
   * 建议的唯一标识符。
   */
  id: string
  /**
   * 需要被替换的内容范围。
   */
  deleteRange: Range
  /**
   * 需要删除的内容（纯文本格式）。
   */
  deleteText: string
  /**
   * 需要删除的slice内容。
   */
  deleteSlice: Slice
  /**
   * 多个替换方案，用户可选择其中一项应用。
   */
  replacementOptions: AiSuggestionReplacementOption[]
  /**
   * 将通过应用此建议遵循的校对规则。
   */
  rule: AiSuggestionRule
  /**
   * 建议是否被用户拒绝。
   */
  isRejected: boolean
  /**
   * 建议的额外元数据，可用于存储一些补充信息（如来源或类别）。这不会被扩展内部使用，但可以帮助开发者自定义建议在UI中的显示方式。
   */
  metadata?: any
}
```

### 被拒建议

```ts
import { AiSuggestionRule } from './ai-suggestion-rule'

/**
 * 表示已被拒绝的建议。它们被存储在AI建议扩展的存储中，
 * 以确保不会再次生成对应建议。
 */
export interface AiSuggestionRejection {
  /**
   * 被拒绝建议所对应的规则。
   */
  rule: AiSuggestionRule
  /**
   * 被拒绝建议原本要删除的文本内容。
   */
  deleteText: string
}
```