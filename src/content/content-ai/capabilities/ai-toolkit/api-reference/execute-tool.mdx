```markdown
---
title: 执行工具（AI 代理）
meta:
  title: 执行工具（AI 代理）| Tiptap Content AI
  description: 使用 AI 工具包对 Tiptap 编辑器执行 AI 代理的工具调用。
  category: 内容 AI
---

使用 `executeTool` 将 AI 代理的工具调用应用到编辑器。

一旦你为 AI 代理添加了 [工具定义](/content-ai/capabilities/ai-toolkit/tools)，AI 代理就会生成工具调用。使用 `executeTool` 方法将工具调用应用到编辑器。

## `executeTool`

通过名称和输入执行支持的工具。

### 参数

- `options` (`ExecuteToolOptions`): 工具执行配置
  - `toolName` (`string`): 要执行的工具。可以是 [可用工具](/content-ai/capabilities/ai-toolkit/tools/available-tools) 之一。
  - `input` (`unknown`): 与工具参数输入模式匹配的 JSON 对象。如果该工具不需要参数，传递空对象 (`{}`)。
  - `chunkSize?` (`number`): 可作为输入传递给 AI 模型的字符串最大大小。防止 AI 一次读取过多内容，以免超过 AI 模型的上下文窗口。默认值：`32000`。该参数由读取工具使用，用于控制文档如何拆分为块。
  - `reviewOptions?` (`ReviewOptions`): 控制预览/审核行为
    - `mode?` (`'disabled' | 'review' | 'preview'`): 是否在应用更改前或后进行审核。`'disabled'` 表示不审核，`'review'` 表示应用后审核，`'preview'` 表示应用前预览。默认值：`'disabled'`
    - `diffMode?` (`'detailed' | 'full'`): 启用审核模式时，如何展示原始内容与修改内容的差异。`'detailed'` 对比更改前后的文档，显示删除内容和新增内容的丰富差异；`'full'` 将删除内容和新增内容作为整块显示，作为包含删除和新增内容的单一变更。默认值：`'detailed'`
    - `displayOptions?` (`DisplayOptions<{ suggestion: Suggestion }>`): 自定义建议的显示方式
      - `showAsDiff?` (`boolean`): 是否将建议显示为差异，对比插入内容和原始内容并列显示。默认值：`true`
      - `diffPosition?` (`'before' | 'after'`): 差异相对于建议的位置。默认值：`'before'`
      - `attributes?` (`Record<string, any>`): 额外的 HTML 属性，添加到建议上
      - `renderDecorations?` (`RenderDecorations<{ suggestion: Suggestion }>`): 以 ProseMirror 装饰形式渲染建议的函数
    - `metadata?` (`Record<string, any>`): 额外元数据，可用于存储有关建议的附加信息（例如来源或类别）。该元数据不会被本扩展内部使用，但可帮助开发者定制建议在 UI 中的展示方式。
  - `commentsOptions?` (`CommentsOptions`): 评论和线程操作的选项。允许为评论和线程的创建/更新操作传递自定义数据。`data` 属性用于线程数据，`commentData` 用于评论数据。
    - `threadData?` (`Record<string, any>`): 用于通过 `editThreads` 工具创建的 AI 生成线程的额外元数据
    - `commentData?` (`Record<string, any>`): 用于通过 `editThreads` 工具创建的 AI 生成评论的额外元数据

### 返回值 (`ExecuteToolResult`)

- `output` (`string`): 工具执行的响应消息，供 AI 代理读取。
- `hasError` (`boolean`): 执行期间是否发生错误
- `unknownTool` (`boolean`): `toolName` 是否未被 AI 工具包识别
- `docChanged` (`boolean`): 工具调用是否修改了文档。

### 示例

```ts
// 处理 tiptapRead 工具调用
const result = toolkit.executeTool({
  toolName: 'tiptapRead',
  input: {
    from: 0,
  },
})
```

完整的实践教程，请参见 [AI 代理聊天机器人指南](/content-ai/capabilities/ai-toolkit/guides/ai-agent-chatbot)。

## `streamTool`

在工具调用流式传输时实时更新文档。

此方法的效果等同于调用 `executeTool`，但它在工具调用流传输时逐步编辑文档，而不是等待流完成后一次性编辑文档。

### 参数

- `options` (`StreamToolOptions`): 工具流式传输的配置
  - `toolCallId` (`unknown`): 工具调用 ID
  - `toolName` (`string`): 要执行的工具。可以是 [可用工具](/content-ai/capabilities/ai-toolkit/tools/available-tools) 之一。
  - `input` (`unknown`): 与工具参数输入模式匹配的 JSON 对象。如果该工具不需要参数，传空对象 (`{}`)。如果工具尚未完成流式传输，此参数应为部分参数的对象，但仍应是有效的 JSON 对象。
  - `hasFinished?` (`boolean`): 工具是否已完成流式传输。默认值：`false`
  - `chunkSize?` (`number`): 可作为输入传递给 AI 模型的字符串最大大小。防止 AI 一次读取过多内容，以免超过 AI 模型的上下文窗口。默认值：`32000`。该参数由读取工具使用，用于控制文档如何拆分为块。
  - `reviewOptions?` (`ReviewOptions`): 控制预览/审核行为
    - `mode?` (`'disabled' | 'review' | 'preview'`): 是否在应用更改前或后进行审核。`'disabled'` 表示不审核，`'review'` 表示应用后审核，`'preview'` 表示应用前预览。默认值：`'disabled'`
    - `diffMode?` (`'detailed' | 'full'`): 启用审核模式时，如何展示原始内容与修改内容的差异。`'detailed'` 对比更改前后的文档，显示删除内容和新增内容的丰富差异；`'full'` 将删除内容和新增内容作为整块显示，作为包含删除和新增内容的单一变更。默认值：`'detailed'`
    - `displayOptions?` (`DisplayOptions<{ suggestion: Suggestion }>`): 自定义建议的显示方式
      - `showAsDiff?` (`boolean`): 是否将建议显示为差异，对比插入内容和原始内容并列显示。默认值：`true`
      - `diffPosition?` (`'before' | 'after'`): 差异相对于建议的位置。默认值：`'before'`
      - `attributes?` (`Record<string, any>`): 额外的 HTML 属性，添加到建议上
      - `renderDecorations?` (`RenderDecorations<{ suggestion: Suggestion }>`): 以 ProseMirror 装饰形式渲染建议的函数
    - `metadata?` (`Record<string, any>`): 额外元数据，可用于存储有关建议的附加信息（例如来源或类别）。该元数据不会被本扩展内部使用，但可帮助开发者定制建议在 UI 中的展示方式。
  - `commentsOptions?` (`CommentsOptions`): 评论和线程操作的选项。允许为评论和线程的创建/更新操作传递自定义数据。`data` 属性用于线程数据，`commentData` 用于评论数据。
    - `threadData?` (`Record<string, any>`): 用于通过 `editThreads` 工具创建的 AI 生成线程的额外元数据
    - `commentData?` (`Record<string, any>`): 用于通过 `editThreads` 工具创建的 AI 生成评论的额外元数据

### 返回值 (`StreamToolResult`)

- `output` (`string`): 工具执行的响应消息，供 AI 代理读取。
- `hasError` (`boolean`): 执行期间是否发生错误
- `unknownTool` (`boolean`): `toolName` 是否未被 AI 工具包识别
- `docChanged` (`boolean`): 工具调用是否修改了文档。

### 示例

`streamTool` 方法在工具调用流式传输过程中被反复调用。当工具调用完成流式传输后，再次调用 `streamTool` 方法并设置 `hasFinished: true`，表示流式传输已结束。

```ts
// 在工具调用生成时进行流式传输。
// 每次接收到新的流式内容时调用 `streamTool`
const result = toolkit.streamTool({
  // 工具仍在流式传输，尚未完成
  hasFinished: false,
  toolCallId: 'call_123',
  toolName: 'tiptapEdit',
  // 内容仍在流式传输，所以传递部分参数对象
  input,
})

// 当工具调用完成时，再次调用并设置 hasFinished: true
const finalResult = toolkit.streamTool({
  // 工具流传输已完成
  hasFinished: true,
  toolCallId: 'call_123',
  toolName: 'tiptapEdit',
  // 流传输已完成，可以传递完整参数对象
  input,
})
```

完整的工具流式传输实践教程，请参见 [带有工具流式传输的 AI 代理聊天机器人指南](/content-ai/capabilities/ai-toolkit/guides/tool-streaming)。

## `getActiveSelection`

返回 `activeSelection` 变量的值。

活动选择是由 AI 工具包设置的范围。设置后，该范围将在诸如 `readSelection` 等操作中代替当前编辑器选择。该范围会通过事务自动映射，以在文档变化时保持位置准确。

### 返回值

- `Range | null`: 活动选择范围，具有 `from` 和 `to` 属性，或当无活动选择时返回 `null`。

### 示例

```ts
const toolkit = getAiToolkit(editor)
const activeSelection = toolkit.getActiveSelection()
```

## `setActiveSelection`

设置 `activeSelection` 变量。该变量用于执行带有 `executeTool` 或 `streamTool` 方法的工具调用时，确定 AI 将在诸如 `readSelection` 等操作中使用的选择范围，代替当前编辑器选择。

活动选择是 AI 应当使用以代替当前编辑器选择的范围。该范围会通过事务自动映射，以在文档变化时保持位置准确。

### 参数

- `selection` (`Range | null`): 要设置的范围，具有 `from` 和 `to` 属性，表示起始和结束位置，或使用 `null` 以清除活动选择。

### 示例

```ts
const toolkit = getAiToolkit(editor)
// 将活动选择设置为当前选择
toolkit.setActiveSelection(editor.state.selection)

// 将活动选择设置为特定范围
toolkit.setActiveSelection({ from: 10, to: 50 })

// 清除活动选择
toolkit.setActiveSelection(null)
```
```