---
title: 审核更改（作为摘要）
meta:
  title: 审核更改（作为摘要） | Tiptap 内容 AI
  description: 预览并批准 AI 插入的更改作为摘要，支持自定义渲染。
  category: 内容 AI
---

import { Callout } from '@/components/ui/Callout'
import { CodeDemo } from '@/components/CodeDemo'

<Callout title="接续 AI 代理聊天机器人指南" variant="info">
  本指南是对[AI 代理聊天机器人指南](/content-ai/capabilities/ai-toolkit/guides/ai-agent-chatbot)的延续。请先阅读该文档。
</Callout>

在 AI 代理完成其工作后，展示所有更改的摘要。

<Callout title="注意">
  本指南是[审核更改指南](/content-ai/capabilities/ai-toolkit/guides/review-changes)的一种变体，这里用户不是每次 AI 编辑文档时审核更改，而是在最后一次性审核所有更改。
</Callout>

要实现此功能，我们将使用 AI 工具包的[实时比较文档](/content-ai/capabilities/ai-toolkit/advanced-guides/compare-documents)能力。

<CodeDemo
  isLarge
  path=""
  isScrollable
  src="https://ai-toolkit-demos.vercel.app/review-changes-as-summary"
/>

查看[GitHub 上的源码](https://github.com/ueberdosis/ai-toolkit-demos)。

当用户向 AI 发送消息时，调用 `startComparingDocuments` 方法。这将开始比较 AI 修改前后的文档。

```ts
// 在 onSubmit 处理器内
const toolkit = getAiToolkit(editor)
toolkit.startComparingDocuments()
```

当 AI 修改文档时，更改会以内联[建议](/content-ai/capabilities/ai-toolkit/api-reference/display-suggestions)的形式显示在编辑器中。

## 建议样式

创建一个 CSS 文件（`app/suggestions.css`）以用红色/绿色渲染建议。

```css
/* 高亮插入的文字为绿色 */
.tiptap-ai-suggestion,
.tiptap-ai-suggestion > * {
  background-color: oklch(87.1% 0.15 154.449);
}

/* Lighter background for change groups (sub-changes carry the stronger highlight) */
.tiptap-ai-suggestion.tiptap-ai-suggestion--change-group,
.tiptap-ai-suggestion.tiptap-ai-suggestion--change-group > *:not(.tiptap-ai-suggestion-sub-change) {
  background-color: oklch(0.962 0.044 156.743);
}

/* Highlight sub-changes within inline groups */
.tiptap-ai-suggestion-sub-change {
  background-color: oklch(87.1% 0.15 154.449);
}

/* 高亮删除的文字为红色 */
.tiptap-ai-suggestion-diff,
.tiptap-ai-suggestion-diff > * {
  background-color: oklch(80.8% 0.114 19.571);
  color: oklch(0.396 0.141 25.723);
}

/* Lighter background for diff change groups (sub-changes carry the stronger highlight) */
.tiptap-ai-suggestion-diff.tiptap-ai-suggestion-diff--change-group,
.tiptap-ai-suggestion-diff.tiptap-ai-suggestion-diff--change-group
  > *:not(.tiptap-ai-suggestion-diff-sub-change) {
  background-color: oklch(0.936 0.032 17.717);
}

/* Highlight sub-changes within the replacement diff widget */
.tiptap-ai-suggestion-diff-sub-change {
  background-color: oklch(80.8% 0.114 19.571);
}

/* Render table row deletions correctly */
.tiptap-ai-suggestion-diff:has(tr) {
  display: contents;
}

.tiptap-ai-suggestion-diff:has(tr) td,
.tiptap-ai-suggestion-diff:has(tr) th {
  background-color: oklch(80.8% 0.114 19.571);
}
```

## 全部接受/拒绝更改

要接受所有更改，调用 `stopComparingDocuments`。这将隐藏差异视图并停止实时文档比较。

```ts
const toolkit = getAiToolkit(editor)

toolkit.stopComparingDocuments()
```

要拒绝所有更改，调用 `rejectAllSuggestions` 方法。这会将编辑器内容重置回 AI 修改前的状态。该方法返回 AI 反馈，你可以收集这些反馈并包含到下一条用户消息中。然后调用 `stopComparingDocuments` 以停止实时文档比较。

```ts
const result = toolkit.rejectAllSuggestions()
// 收集反馈事件，以便包含到下一条用户消息
const userFeedback = result.aiFeedback.events
toolkit.stopComparingDocuments()
```

## 接受/拒绝单个更改

你还可以在建议上显示按钮或弹出框，提供接受或拒绝对应更改的操作。

要在界面中渲染自定义元素，设置 `displayOptions` 参数，在其中设置 `renderDecorations` 选项。它是一个返回[ProseMirror 装饰物](https://prosemirror.net/docs/ref/#view.Decorations)数组的函数。

`acceptSuggestion` 和 `rejectSuggestion` 方法返回 AI 反馈，你可以收集这些反馈并发送给 AI，以改进未来的建议。

```tsx
toolkit.startComparingDocuments({
  displayOptions: {
    renderDecorations(options) {
      return [
        ...options.defaultRenderDecorations(),

        // 接受按钮
        Decoration.widget(options.range.to, () => {
          const element = document.createElement('button')
          element.textContent = '接受'
          element.addEventListener('click', () => {
            const result = toolkit.acceptSuggestion(options.suggestion.id)
            // 收集反馈事件
            setReviewState((prev) => ({
              ...prev,
              userFeedback: [...prev.userFeedback, ...result.aiFeedback.events],
            }))
            if (toolkit.getSuggestions().length === 0) {
              stopComparing()
            }
          })
          return element
        }),

        // 拒绝按钮
        Decoration.widget(options.range.to, () => {
          const element = document.createElement('button')
          element.textContent = '拒绝'
          element.addEventListener('click', () => {
            const result = toolkit.rejectSuggestion(options.suggestion.id)
            // 收集反馈事件
            setReviewState((prev) => ({
              ...prev,
              userFeedback: [...prev.userFeedback, ...result.aiFeedback.events],
            }))
            if (toolkit.getSuggestions().length === 0) {
              stopComparing()
            }
          })
          return element
        }),
      ]
    },
  },
})
```

## 完整演示代码

```tsx
// app/page.tsx
'use client'

import { useChat } from '@ai-sdk/react'
import { Decoration } from '@tiptap/pm/view'
import { EditorContent, useEditor } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import { AiToolkit, getAiToolkit, type SuggestionFeedbackEvent } from '@tiptap-pro/ai-toolkit'
import { DefaultChatTransport, lastAssistantMessageIsCompleteWithToolCalls } from 'ai'
import { useState } from 'react'
import './suggestions.css'

export default function Page() {
  const editor = useEditor({
    immediatelyRender: false,
    extensions: [StarterKit, AiToolkit],
    content: `<h1>AI 代理演示</h1><p>让 AI 改进这段内容。</p>`,
  })

  const { messages, sendMessage, addToolOutput, status } = useChat({
    transport: new DefaultChatTransport({ api: '/api/chat' }),
    sendAutomaticallyWhen: lastAssistantMessageIsCompleteWithToolCalls,
    async onToolCall({ toolCall }) {
      if (!editor) return

      const { toolName, input, toolCallId } = toolCall

      // 重置反馈事件，当开始新的工具调用时
      setReviewState((prev) => ({ ...prev, userFeedback: [] }))

      // 使用 AI 工具包执行工具
      const toolkit = getAiToolkit(editor)
      const result = toolkit.executeTool({
        toolName,
        input,
      })

      addToolOutput({ tool: toolName, toolCallId, output: result.output })
    },
  })

  const [input, setInput] = useState('用一个关于 Tiptap 的短故事替换最后一段')
  const [reviewState, setReviewState] = useState({
    isComparing: false,
    userFeedback: [] as SuggestionFeedbackEvent[],
  })

  if (!editor) return null

  const toolkit = getAiToolkit(editor)

  function stopComparing() {
    toolkit.stopComparingDocuments()
    setReviewState((prev) => ({ ...prev, isComparing: false }))
  }

  const showReviewUI = reviewState.isComparing && status === 'ready'

  return (
    <div>
      <EditorContent editor={editor} />
      {messages?.map((message) => (
        <div key={message.id} style={{ whiteSpace: 'pre-wrap' }}>
          <strong>{message.role}</strong>
          <br />
          {message.parts
            .filter((p) => p.type === 'text')
            .map((p) => p.text)
            .join('\n')}
        </div>
      ))}
      {!showReviewUI && (
        <form
          onSubmit={(e) => {
            e.preventDefault()

            if (reviewState.isComparing) return

            // 构造消息文本，包含反馈（如果有）
            let messageText = input.trim()
            if (reviewState.userFeedback.length > 0) {
              const feedbackOutput = JSON.stringify(reviewState.userFeedback)
              messageText += `\n\n<user_feedback>${feedbackOutput}</user_feedback>`
            }

            toolkit.startComparingDocuments({
              displayOptions: {
                renderDecorations(options) {
                  return [
                    ...options.defaultRenderDecorations(),

                    // 接受按钮
                    Decoration.widget(options.range.to, () => {
                      const element = document.createElement('button')
                      element.textContent = '接受'
                      element.addEventListener('click', () => {
                        const result = toolkit.acceptSuggestion(options.suggestion.id)
                        setReviewState((prev) => ({
                          ...prev,
                          userFeedback: [...prev.userFeedback, ...result.aiFeedback.events],
                        }))
                        if (toolkit.getSuggestions().length === 0) {
                          stopComparing()
                        }
                      })
                      return element
                    }),

                    // 拒绝按钮
                    Decoration.widget(options.range.to, () => {
                      const element = document.createElement('button')
                      element.textContent = '拒绝'
                      element.addEventListener('click', () => {
                        const result = toolkit.rejectSuggestion(options.suggestion.id)
                        setReviewState((prev) => ({
                          ...prev,
                          userFeedback: [...prev.userFeedback, ...result.aiFeedback.events],
                        }))
                        if (toolkit.getSuggestions().length === 0) {
                          stopComparing()
                        }
                      })
                      return element
                    }),
                  ]
                },
              },
            })
            setReviewState((prev) => ({ ...prev, isComparing: true }))

            if (messageText) {
              sendMessage({ text: messageText })
              setInput('')
              setReviewState((prev) => ({ ...prev, userFeedback: [] }))
            }
          }}
        >
          <input
            disabled={reviewState.isComparing}
            value={input}
            onChange={(e) => setInput(e.target.value)}
          />
        </form>
      )}
      {showReviewUI && (
        <div>
          <h2>审核更改</h2>
          <button
            onClick={() => {
              const result = toolkit.acceptAllSuggestions()
              // 收集所有反馈事件
              const userFeedback = [...reviewState.userFeedback, ...result.aiFeedback.events]
              setReviewState({
                isComparing: false,
                userFeedback,
              })
              toolkit.stopComparingDocuments()
            }}
          >
            全部接受
          </button>
          <button
            onClick={() => {
              const result = toolkit.rejectAllSuggestions()
              // 收集所有反馈事件
              const userFeedback = [...reviewState.userFeedback, ...result.aiFeedback.events]
              setReviewState({
                isComparing: false,
                userFeedback,
              })
              toolkit.stopComparingDocuments()
            }}
          >
            全部拒绝
          </button>
        </div>
      )}
    </div>
  )
}
```

## 最终效果

加入额外的 CSS 样式后，结果是一个简单但精致的 AI 聊天机器人应用，用户可在 AI 完成工作后审核所有 AI 生成的更改：

<CodeDemo
  isLarge
  path=""
  isScrollable
  src="https://ai-toolkit-demos.vercel.app/review-changes-as-summary"
/>

查看[GitHub 上的源码](https://github.com/ueberdosis/ai-toolkit-demos)。

## 后续步骤

了解更多关于 AI 工具包的[实时比较文档](/content-ai/capabilities/ai-toolkit/advanced-guides/compare-documents)功能。
