---
title: 审核更改（作为摘要）
meta:
  title: 审核更改（作为摘要） | Tiptap 内容 AI
  description: 预览并批准 AI 插入的更改作为摘要，支持自定义渲染。
  category: 内容 AI
---

import { Callout } from '@/components/ui/Callout'
import { CodeDemo } from '@/components/CodeDemo'

<Callout title="接续 AI 代理聊天机器人指南" variant="info">
  本指南是对[AI 代理聊天机器人指南](/content-ai/capabilities/ai-toolkit/guides/ai-agent-chatbot)的延续。请先阅读该文档。
</Callout>

在 AI 代理完成其工作后，展示所有更改的摘要。

<Callout title="注意">
  本指南是[审核更改指南](/content-ai/capabilities/ai-toolkit/guides/review-changes)的一种变体，这里用户不是每次 AI 编辑文档时审核更改，而是在最后一次性审核所有更改。
</Callout>

要实现此功能，我们将使用 AI 工具包的[实时比较文档](/content-ai/capabilities/ai-toolkit/primitives/compare-documents)能力。

<CodeDemo
  path=""
  isScrollable
  src="https://ai-toolkit-demos.vercel.app/review-changes-as-summary"
/>

查看[GitHub 上的源码](https://github.com/ueberdosis/ai-toolkit-demos)。

当用户向 AI 发送消息时，调用 `startComparingDocuments` 方法。这将开始比较 AI 修改前后的文档。

```ts
// 在 onSubmit 处理器内
const toolkit = getAiToolkit(editor)
toolkit.startComparingDocuments()
```

当 AI 修改文档时，更改会以内联[建议](/content-ai/capabilities/ai-toolkit/primitives/display-suggestions)的形式显示在编辑器中。

## 建议样式

创建一个 CSS 文件（`app/suggestions.css`）以用红色/绿色渲染建议。

```css
/* 高亮插入的文字为绿色 */
.tiptap-ai-suggestion,
.tiptap-ai-suggestion > * {
  background-color: oklch(87.1% 0.15 154.449);
}
.tiptap-ai-suggestion--selected,
.tiptap-ai-suggestion--selected > * {
  background-color: oklch(79.2% 0.209 151.711);
}

/* 高亮删除的文字为红色 */
.tiptap-ai-suggestion-diff,
.tiptap-ai-suggestion-diff > * {
  background-color: oklch(80.8% 0.114 19.571);
}
.tiptap-ai-suggestion-diff--selected,
.tiptap-ai-suggestion-diff--selected > * {
  background-color: oklch(70.4% 0.191 22.216);
}
```

## 全部接受/拒绝更改

要接受所有更改，调用 `stopComparingDocuments`。这将隐藏差异视图并停止实时文档比较。

```ts
const toolkit = getAiToolkit(editor)

toolkit.stopComparingDocuments()
```

要拒绝所有更改，调用 `rejectAllChanges` 方法。这会将编辑器内容重置回 AI 修改前的状态。然后调用 `stopComparingDocuments` 以停止实时文档比较。

```ts
toolkit.rejectAllChanges()
toolkit.stopComparingDocuments()
```

## 接受/拒绝单个更改

你还可以在建议上显示按钮或弹出框，提供接受或拒绝对应更改的操作。

要在界面中渲染自定义元素，设置 `displayOptions` 参数，在其中设置 `renderDecorations` 选项。它是一个返回[ProseMirror 装饰物](https://prosemirror.net/docs/ref/#view.Decorations)数组的函数。

```tsx
toolkit.startComparingDocuments({
  displayOptions: {
    renderDecorations(options) {
      return [
        ...options.defaultRenderDecorations(),

        // 接受按钮
        Decoration.widget(options.range.to, () => {
          const element = document.createElement('button')
          element.textContent = '接受'
          element.addEventListener('click', () => {
            toolkit.acceptChange(options.suggestion.id)
          })
          return element
        }),

        // 拒绝按钮
        Decoration.widget(options.range.to, () => {
          const element = document.createElement('button')
          element.textContent = '拒绝'
          element.addEventListener('click', () => {
            toolkit.rejectChange(options.suggestion.id)
          })
          return element
        }),
      ]
    },
  },
})
```

## 完整演示代码

```tsx
// app/page.tsx
'use client'

import { DefaultChatTransport, lastAssistantMessageIsCompleteWithToolCalls } from 'ai'
import { useChat } from '@ai-sdk/react'
import { EditorContent, useEditor } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import { useRef, useState } from 'react'
import { AiToolkit, getAiToolkit } from '@tiptap-pro/ai-toolkit'
import { Decoration } from '@tiptap/pm/view'
import './suggestions.css'

export default function Page() {
  const editor = useEditor({
    immediatelyRender: false,
    extensions: [StarterKit, AiToolkit],
    content: `<h1>AI 代理演示</h1><p>让 AI 改进这段内容。</p>`,
  })

  // 修复问题：https://github.com/vercel/ai/issues/8148
  const editorRef = useRef(editor)
  editorRef.current = editor

  const { messages, sendMessage, addtoolOutput, status } = useChat({
    transport: new DefaultChatTransport({ api: '/api/chat' }),
    sendAutomaticallyWhen: lastAssistantMessageIsCompleteWithToolCalls,
    async onToolCall({ toolCall }) {
      const editor = editorRef.current
      if (!editor) return

      const { toolName, input, toolCallId } = toolCall

      // 使用 AI 工具包执行工具
      const toolkit = getAiToolkit(editor)
      const result = toolkit.executeTool({
        toolName,
        input,
      })

      addtoolOutput({ tool: toolName, toolCallId, output: result.output })
    },
  })

  const [input, setInput] = useState('用一个关于 Tiptap 的短故事替换最后一段')
  const [isComparing, setIsComparing] = useState(false)

  if (!editor) return null

  const toolkit = getAiToolkit(editor)

  const showReviewUI = isComparing && status === 'ready'

  return (
    <div>
      <EditorContent editor={editor} />
      {messages?.map((message) => (
        <div key={message.id} style={{ whiteSpace: 'pre-wrap' }}>
          <strong>{message.role}</strong>
          <br />
          {message.parts
            .filter((p) => p.type === 'text')
            .map((p) => p.text)
            .join('\n')}
        </div>
      ))}
      {!showReviewUI && (
        <form
          onSubmit={(e) => {
            e.preventDefault()

            if (isComparing) return

            toolkit.startComparingDocuments({
              displayOptions: {
                renderDecorations(options) {
                  return [
                    ...options.defaultRenderDecorations(),

                    // 接受按钮
                    Decoration.widget(options.range.to, () => {
                      const element = document.createElement('button')
                      element.textContent = '接受'
                      element.addEventListener('click', () => {
                        toolkit.acceptChange(options.suggestion.id)
                      })
                      return element
                    }),

                    // 拒绝按钮
                    Decoration.widget(options.range.to, () => {
                      const element = document.createElement('button')
                      element.textContent = '拒绝'
                      element.addEventListener('click', () => {
                        toolkit.rejectChange(options.suggestion.id)
                      })
                      return element
                    }),
                  ]
                },
              },
            })
            setIsComparing(true)

            sendMessage({ text: input })
            setInput('')
          }}
        >
          <input disabled={isComparing} value={input} onChange={(e) => setInput(e.target.value)} />
        </form>
      )}
      {showReviewUI && (
        <div>
          <h2>审核更改</h2>
          <button
            onClick={() => {
              toolkit.stopComparingDocuments()
              setIsComparing(false)
            }}
          >
            全部接受
          </button>
          <button
            onClick={() => {
              toolkit.rejectAllChanges()
              toolkit.stopComparingDocuments()
              setIsComparing(false)
            }}
          >
            全部拒绝
          </button>
        </div>
      )}
    </div>
  )
}
```

## 最终效果

加入额外的 CSS 样式后，结果是一个简单但精致的 AI 聊天机器人应用，用户可在 AI 完成工作后审核所有 AI 生成的更改：

<CodeDemo
  path=""
  isScrollable
  src="https://ai-toolkit-demos.vercel.app/review-changes-as-summary"
/>

查看[GitHub 上的源码](https://github.com/ueberdosis/ai-toolkit-demos)。

## 后续步骤

了解更多关于 AI 工具包的[实时比较文档](/content-ai/capabilities/ai-toolkit/primitives/compare-documents)功能。